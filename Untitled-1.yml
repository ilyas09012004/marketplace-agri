openapi: 3.0.3
info:
  title: Dokumentasi API Agri-X
  description: API untuk marketplace pertanian Agri-X, melayani fitur produk, keranjang, pesanan, alamat pengiriman, dan integrasi ongkir.
  version: 1.0.0
servers:
  - url: http://localhost:3000
    description: Server pengembangan (development)

tags:
  - name: Authentication
    description: Manajemen autentikasi dan sesi pengguna
  - name: Produk
    description: Operasi CRUD untuk produk pertanian
  - name: Keranjang
    description: Manajemen item dalam keranjang belanja pengguna
  - name: Checkout
    description: Proses checkout dan pembuatan pesanan
  - name: Alamat
    description: Operasi CRUD untuk alamat pengiriman pengguna
  - name: Pengiriman
    description: Integrasi dengan layanan eksternal untuk estimasi ongkos kirim
  - name: Pesanan
    description: Manajemen pesanan pengguna (lihat, buat, ubah status, batalkan)
  

paths:
  /api/auth/register:
    post:
      tags: [Authentication]
      summary: Daftarkan pengguna baru
      description: |
        Membuat akun pengguna baru di sistem Agri-X.
        - Email harus unik dan belum terdaftar.
        - Kata sandi minimal 6 karakter.
        - Tidak mengeluarkan token — pengguna harus login secara terpisah setelah registrasi.
        - Role default adalah `user`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password, name]
              properties:
                email:
                  type: string
                  format: email
                  example: "ilyas@example.com"
                  description: Alamat email unik pengguna
                password:
                  type: string
                  minLength: 6
                  example: "kataSandiAman123"
                  description: Kata sandi minimal 6 karakter
                name:
                  type: string
                  example: "Mohammad Ilyas"
                  description: Nama lengkap pengguna
      responses:
        '201':
          description: Pengguna berhasil didaftarkan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "User registered successfully. Please log in."
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: "123"
                        description: ID pengguna sebagai string
                      email:
                        type: string
                        example: "ilyas@example.com"
                        description: Email pengguna
                      name:
                        type: string
                        example: "Mohammad Ilyas"
                        description: Nama pengguna
                      role:
                        type: string
                        example: "user"
                        description: Peran pengguna (default user)
        '400':
          description: Data tidak lengkap atau tidak valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Password must be at least 6 characters"
        '409':
          description: Email sudah terdaftar
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Email already registered"
        '500':
          description: Layanan registrasi tidak tersedia
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Registration service unavailable"
                    description: Pesan kesalahan jika layanan registrasi tidak tersedia
  /api/auth/login:
    post:
      tags: [Authentication]
      summary: Melakukan autentikasi pengguna dan memulai sesi
      description: |
        Memverifikasi kredensial pengguna dan mengeluarkan token JWT melalui cookie yang aman.
        - **accessToken** disimpan dalam cookie **non-HttpOnly** (dapat diakses oleh JavaScript frontend).
        - **refreshToken** disimpan dalam cookie **HttpOnly** (tidak dapat diakses JavaScript, melindungi dari serangan XSS).
        - Respons **tidak mengandung token** di body — semua token hanya dikirim via cookie.
        - Informasi sesi (browser, perangkat, IP) dicatat di database melalui stored procedure.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "ilyas@kedamean.desa.id"
                password:
                  type: string
                  format: password
                  example: "rahasia123"
      responses:
        '200':
          description: Login berhasil. Token disetel melalui cookie.
          headers:
            Set-Cookie:
              description: |
                Dua cookie disetel:
                - `accessToken`: non-HttpOnly, berlaku 7 hari, path `/`.
                - `refreshToken`: HttpOnly, berlaku 7 hari, path `/`.
              schema:
                type: string
                example: "accessToken=eyJ...; Path=/; Max-Age=604800; ... refreshToken=eyJ...; Path=/; HttpOnly; Max-Age=604800; ..."
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: "1"
                      email:
                        type: string
                        example: "mi658672@gmail.com"
                      name:
                        type: string
                        example: "Ilyas"
                      role:
                        type: string
                        example: "admin"
                      token:
                        type: string
                        example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiw"
        '400':
          description: Email atau kata sandi tidak dikirim
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Email and password required"
        '401':
          description: Email atau kata sandi salah
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Invalid credentials"
        '500':
          description: Layanan autentikasi tidak tersedia
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Authentication service unavailable"

  /api/auth/logout:
    post:
      tags: [Authentication]
      summary: Logout pengguna dan batalkan sesi saat ini
      description: |
        Membatalkan token refresh yang sedang aktif (jika ada) dan menghapus cookie autentikasi.
        - Aman dipanggil meskipun pengguna belum login.
        - Tidak memerlukan body pada request.
        - Selalu mengembalikan status 200 OK demi keamanan (menghindari kebocoran informasi).
      responses:
        '200':
          description: Berhasil logout. Cookie autentikasi telah dihapus.
          headers:
            Set-Cookie:
              description: |
                Menghapus kedua cookie dengan mengatur maxAge=0:
                - `accessToken`
                - `refreshToken`
              schema:
                type: string
                example: "accessToken=; Path=/; Max-Age=0, refreshToken=; Path=/; Max-Age=0"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true

  /api/auth/refresh:
    post:
      tags: [Authentication]
      summary: Memperbarui token akses menggunakan refresh token
      description: |
        Endpoint ini memverifikasi refresh token dari cookie HttpOnly,
        lalu menghasilkan pasangan token akses dan refresh token baru jika masih valid.
        
        - Refresh token lama **dicabut (revoked)** setelah pembaruan.
        - Session baru dibuat di database untuk keamanan (rotasi token).
        - Token akses baru berlaku 15 menit, refresh token baru berlaku 7 hari.
        - Tidak menerima body request — semua data diambil dari cookie dan database.
      responses:
        '200':
          description: Token berhasil diperbarui. Cookie baru disetel.
          headers:
            Set-Cookie:
              description: |
                Dua cookie baru disetel:
                - `accessToken`: non-HttpOnly, masa berlaku 15 menit.
                - `refreshToken`: HttpOnly, masa berlaku 7 hari, hanya untuk path `/api/auth/refresh`.
              schema:
                type: string
                example: "accessToken=eyJ...; Path=/; Max-Age=900, refreshToken=eyJ...; Path=/api/auth/refresh; HttpOnly; Max-Age=604800"
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          description: Gagal memperbarui token (token tidak ada, tidak valid, kadaluarsa, atau session dicabut)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Refresh token expired"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/products:
    get:
      tags: [Produk]
      summary: Ambil daftar produk
      description: |
        Mengambil daftar produk yang tersedia (status != 'sold_out').
        Dapat difilter berdasarkan kategori, dan menggunakan pagination.
      parameters:
        - name: category
          in: query
          required: false
          schema:
            type: string
          description: Filter produk berdasarkan kategori (misal "sayuran", "buah")
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
          description: Jumlah maksimum produk yang dikembalikan
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
          description: Jumlah produk yang dilewati (untuk pagination)
      responses:
        '200':
          description: Daftar produk berhasil diambil
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  products:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProductResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Produk]
      summary: Tambah produk baru
      description: |
        Menambahkan produk baru ke sistem.
        **Akses berdasarkan role:**
        - **Admin**: boleh menentukan `seller_id` apa saja.
        - **Seller**: hanya boleh menggunakan `seller_id` yang sama dengan ID-nya sendiri.
        - **Buyer**: tidak diizinkan.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreateRequest'
      responses:
        '200':
          description: Produk berhasil dibuat
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  product:
                    $ref: '#/components/schemas/ProductResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Akses ditolak berdasarkan role atau kepemilikan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Buyers cannot create products"
        '500':
          $ref: '#/components/responses/InternalServerError'

    
  /api/products/{id}:
    get:
      tags: [Produk]
      summary: Ambil detail produk berdasarkan ID
      description: Mengambil detail produk spesifik (hanya produk dengan status != 'deleted').
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: ID numerik dari produk
      responses:
        '200':
          description: Produk ditemukan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  product:
                    $ref: '#/components/schemas/ProductResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          description: Produk tidak ditemukan atau telah dihapus
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Product not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Produk]
      summary: Lakukan aksi khusus pada produk (restock, ubah min_Pesanan)
      description: |
        Melakukan operasi khusus pada produk.
        **Akses berdasarkan role:**
        - **Admin**: boleh lakukan aksi pada semua produk.
        - **Seller**: hanya boleh lakukan aksi pada produk milik sendiri.
        - **Buyer**: tidak diizinkan.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/ProductRestockAction'
                - $ref: '#/components/schemas/ProductUpdateMinPesananAction'
                - $ref: '#/components/schemas/ProductCustomAction'
      responses:
        '200':
          description: Aksi berhasil dilakukan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                  product:
                    $ref: '#/components/schemas/ProductResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Akses ditolak — bukan pemilik atau bukan admin
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "You can only modify your own products"
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Produk]
      summary: Perbarui seluruh data produk
      description: |
        Mengganti seluruh data produk dengan payload baru.
        **Akses berdasarkan role:**
        - **Admin**: boleh ubah semua produk.
        - **Seller**: hanya boleh ubah produk milik sendiri.
        - **Buyer**: tidak diizinkan.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductUpdateRequest'
      responses:
        '200':
          description: Produk berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  product:
                    $ref: '#/components/schemas/ProductResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Produk]
      summary: Perbarui sebagian data produk
      description: |
        Memperbarui hanya field yang dikirim dalam request.
        **Akses berdasarkan role:**
        - **Admin**: boleh ubah semua produk.
        - **Seller**: hanya boleh ubah produk milik sendiri.
        - **Buyer**: tidak diizinkan.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductPartialUpdateRequest'
      responses:
        '200':
          description: Produk sebagian berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  product:
                    $ref: '#/components/schemas/ProductResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Produk]
      summary: Hapus produk (soft delete)
      description: |
        Menandai produk sebagai 'deleted' (tidak benar-benar dihapus dari DB).
        **Akses berdasarkan role:**
        - **Admin**: boleh hapus semua produk.
        - **Seller**: hanya boleh hapus produk milik sendiri.
        - **Buyer**: tidak diizinkan.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Produk berhasil dihapus
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Product deleted successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/cart:
    get:
      tags: [Keranjang]
      summary: Ambil semua item dalam keranjang pengguna
      description: |
        Mengembalikan daftar item di keranjang pengguna yang sedang login,
        termasuk detail produk (nama, harga, berat, origin) dan total berat keseluruhan.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Berhasil mengambil keranjang
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  cartItems:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 101
                        userId:
                          type: string
                          example: "123"
                        productId:
                          type: integer
                          example: 5
                        quantity:
                          type: integer
                          example: 2
                        createdAt:
                          type: string
                          format: date-time
                        updatedAt:
                          type: string
                          format: date-time
                        product:
                          type: object
                          properties:
                            id:
                              type: integer
                              example: 5
                            name:
                              type: string
                              example: "Apel Malang"
                            price:
                              type: integer
                              example: 12000
                            image:
                              type: string
                              example: "/uploads/apel.jpg"
                            weight:
                              type: integer
                              description: Berat per unit dalam gram
                              example: 200
                            originVillageCode:
                              type: string
                              example: "3578011001"
                  totalWeight:
                    type: integer
                    description: Total berat keranjang (gram)
                    example: 400
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Keranjang]
      summary: Tambah produk ke keranjang
      description: |
        Menambahkan produk ke keranjang pengguna.
        - Jika produk sudah ada, jumlahnya akan dijumlahkan.
        - Validasi otomatis berdasarkan status produk:
          - `ready_stock`: cek stok dan minimal Pesanan.
          - `pre_Pesanan`: hanya cek minimal Pesanan.
          - `sold_out`/`deleted`: ditolak.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [productId, quantity]
              properties:
                productId:
                  type: integer
                  example: 5
                quantity:
                  type: integer
                  minimum: 1
                  example: 2
      responses:
        '200':
          description: Produk berhasil ditambahkan ke keranjang
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Product added to cart successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/cart/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: ID unik dari item di keranjang (bukan ID produk)

    put:
      tags: [Keranjang]
      summary: Ganti seluruh jumlah item di keranjang berdasarkan ID item
      description: |
        Memperbarui jumlah suatu item di keranjang menggunakan **cart item ID**.
        - Jika `quantity = 0`, item tetap ada di keranjang (tidak dihapus otomatis).
        - Validasi stok dan minimal order tetap berlaku sesuai status produk.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [quantity]
              properties:
                quantity:
                  type: integer
                  minimum: 0
                  description: Jumlah baru untuk item ini
                  example: 3
      responses:
        '200':
          description: Jumlah item berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Cart item quantity updated successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Keranjang]
      summary: Perbarui sebagian data item di keranjang (saat ini hanya quantity)
      description: |
        Melakukan pembaruan parsial pada item keranjang.
        - Saat ini hanya mendukung field `quantity`.
        - Jika `quantity` tidak dikirim, tidak ada yang diubah.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                quantity:
                  type: integer
                  minimum: 0
                  description: Jumlah baru (opsional, tapi minimal satu field harus dikirim)
                  example: 2
      responses:
        '200':
          description: Item keranjang berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Cart item updated successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Keranjang]
      summary: Hapus item dari keranjang berdasarkan ID item
      description: Menghapus satu item dari keranjang menggunakan **cart item ID**.
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Item berhasil dihapus dari keranjang
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Cart item removed successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/checkout:
    post:
      tags: [Checkout]
      summary: Proses checkout dan buat pesanan baru
      description: |
        Memproses pembelian dari keranjang pengguna:
        - Memvalidasi stok produk
        - Mengurangi stok setelah pesanan dibuat
        - Mengosongkan keranjang setelah checkout sukses
        - Menggunakan transaksi database untuk memastikan konsistensi data
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [addressId, shippingOption, paymentMethod, totalAmount]
              properties:
                addressId:
                  type: integer
                  description: ID alamat pengiriman yang dipilih
                  example: 123
                shippingOption:
                  type: string
                  description: Biaya ongkos kirim yang dipilih (dalam string angka, contoh "15000")
                  example: "15000"
                paymentMethod:
                  type: string
                  description: Metode pembayaran (misal "transfer", "cod", "qris")
                  example: "transfer"
                totalAmount:
                  type: number
                  format: float
                  description: Total akhir yang harus dibayar (termasuk produk + ongkir), dikirim dari frontend
                  example: 78500
      responses:
        '200':
          description: Checkout berhasil. Pesanan dibuat dan stok diperbarui.
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  PesananId:
                    type: integer
                    description: ID pesanan yang baru dibuat
                    example: 456
        '400':
          description: Data tidak lengkap atau tidak valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Missing required fields or invalid totalAmount"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Alamat tidak ditemukan atau tidak dimiliki pengguna
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Address not found"
        '409':
          description: Stok produk tidak mencukupi saat checkout
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Stock for product 789 is insufficient"
        '500':
          description: Gagal memproses checkout (rollback otomatis dilakukan)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to process checkout"

  /api/address:
    get:
      tags: [Alamat]
      summary: Ambil semua alamat milik pengguna yang terautentikasi
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Berhasil mengambil daftar alamat
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  addresses:
                    type: array
                    items:
                      $ref: '#/components/schemas/AddressResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Alamat]
      summary: Tambah alamat baru untuk pengguna yang terautentikasi
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddressCreateRequest'
      responses:
        '200':
          description: Alamat berhasil ditambahkan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  address:
                    $ref: '#/components/schemas/AddressResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Alamat]
      summary: Perbarui penuh alamat yang sudah ada (memerlukan seluruh data)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/AddressUpdateRequest'
                - required: [id]
      responses:
        '200':
          description: Alamat berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  address:
                    $ref: '#/components/schemas/AddressResponse'
                  message:
                    type: string
                    example: "Alamat berhasil diperbarui."
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Alamat]
      summary: Perbarui sebagian alamat (kirim hanya field yang berubah)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: integer
                  description: ID alamat yang akan diperbarui
                  example: 123
                detail:
                  type: string
                  example: "Jl. Merdeka No. 45"
                cityId:
                  type: string
                  example: "3578"
                districtId:
                  type: string
                  example: "357801"
                villageCode:
                  type: string
                  example: "3578011001"
                province:
                  type: string
                  example: "Jawa Timur"
                zipCode:
                  type: string
                  example: "61151"
              required: [id]
      responses:
        '200':
          description: Alamat berhasil diperbarui sebagian
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  address:
                    $ref: '#/components/schemas/AddressResponse'
                  message:
                    type: string
                    example: "Alamat berhasil diperbarui."
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Alamat]
      summary: Hapus alamat berdasarkan ID
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: integer
                  description: ID alamat yang akan dihapus
                  example: 123
              required: [id]
      responses:
        '200':
          description: Alamat berhasil dihapus
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Alamat berhasil dihapus."
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /locations/provinces:
    get:
      tags: [Lokasi]
      summary: Ambil daftar semua provinsi
      description: |
        Mengambil data provinsi dari database lokal.
        Data diurutkan berdasarkan nama provinsi secara alfabetis (A–Z).
      responses:
        '200':
          description: Berhasil mengambil daftar provinsi
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          description: ID provinsi
                          example: 11
                        name:
                          type: string
                          description: Nama provinsi
                          example: "Aceh"
                      required: [id, name]
        '500':
          description: Gagal mengambil data dari database
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Failed to fetch provinces"

  /api/locations/regencies/{provinceId}:
    get:
      tags: [Lokasi]
      summary: Ambil daftar kabupaten/kota berdasarkan ID provinsi
      description: Mengambil semua kabupaten/kota yang terdaftar dalam provinsi tertentu dari database lokal.
      parameters:
        - name: provinceId
          in: path
          required: true
          schema:
            type: string
          description: ID provinsi (misalnya "35" untuk Jawa Timur)
      responses:
        '200':
          description: Daftar kabupaten/kota berhasil diambil
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 3501
                        name:
                          type: string
                          example: "Kabupaten Gresik"
        '400':
          description: ID provinsi tidak valid atau kosong
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Kesalahan server saat mengambil data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'

    post:
      tags: [Lokasi]
      summary: Tambahkan kabupaten/kota baru ke dalam provinsi
      description: |
        Menambahkan entri kabupaten/kota baru ke database untuk provinsi yang ditentukan.
        - Nama kabupaten/kota harus unik dalam cakupan provinsi tersebut.
        - Hanya digunakan untuk pengelolaan data master (misal: oleh admin).
      parameters:
        - name: provinceId
          in: path
          required: true
          schema:
            type: string
          description: ID provinsi tempat kabupaten/kota akan ditambahkan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Nama kabupaten/kota (misal "Kabupaten Gresik")
                  example: "Kabupaten Lamongan"
      responses:
        '200':
          description: Kabupaten/kota berhasil ditambahkan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Regency created successfully"
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 3512
                      name:
                        type: string
                        example: "Kabupaten Lamongan"
        '400':
          description: Input tidak valid (nama kosong, duplikat, atau provinceId tidak valid)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
        '500':
          description: Kesalahan server saat menambahkan data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/APIError'
  
  /api/locations/districts/{regencyId}:
    get:
      tags: [Lokasi]
      summary: Ambil daftar kecamatan berdasarkan ID kabupaten
      description: Mengembalikan semua kecamatan yang termasuk dalam kabupaten tertentu, diurutkan secara alfabetis.
      parameters:
        - name: regencyId
          in: path
          required: true
          schema:
            type: string
          description: ID kabupaten (misal "3578" untuk Kab. Gresik)
          example: "3578"
      responses:
        '200':
          description: Berhasil mengambil daftar kecamatan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                    description: Status keberhasilan
                  data:
                    type: array
                    description: Daftar kecamatan
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          example: "357801"
                          description: ID kecamatan
                        name:
                          type: string
                          example: "Kedamean"
                          description: Nama kecamatan
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Lokasi]
      summary: Tambahkan kecamatan baru ke dalam kabupaten tertentu
      description: |
        Digunakan untuk menambahkan data kecamatan baru ke dalam sistem.
        Hanya boleh diakses oleh admin atau sistem internal (tidak untuk pengguna biasa).
      parameters:
        - name: regencyId
          in: path
          required: true
          schema:
            type: string
          description: ID kabupaten tempat kecamatan akan ditambahkan
          example: "3578"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Nama kecamatan
                  example: "Menganti"
      responses:
        '200':
          description: Kecamatan berhasil ditambahkan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "District created successfully"
                  id:
                    type: integer
                    description: ID kecamatan yang baru dibuat
                    example: 12345
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          description: Kabupaten tidak ditemukan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Regency not found"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/locations/villages/{districtId}:
    get:
      tags: [Lokasi]
      summary: Ambil daftar desa berdasarkan ID kecamatan
      description: |
        Mengambil semua desa/kelurahan yang termasuk dalam suatu kecamatan (district).
        Data diambil dari tabel `villages` di database lokal Agri-X.
      parameters:
        - name: districtId
          in: path
          required: true
          description: ID kecamatan (district) dari sistem eksternal (misal RajaOngkir atau api.co.id)
          schema:
            type: string
            example: "357801"
      responses:
        '200':
          description: Berhasil mengambil daftar desa
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 12345
                        name:
                          type: string
                          example: "Kedamean"
                      required: [id, name]
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Lokasi]
      summary: Tambahkan desa baru ke dalam database (hanya untuk admin/maintenance)
      description: |
        Menambahkan entri desa baru ke tabel `villages` di database lokal.
        Biasanya digunakan hanya saat inisialisasi data atau pemeliharaan sistem.
        Tidak disarankan untuk penggunaan umum di frontend.
      parameters:
        - name: districtId
          in: path
          required: true
          description: ID kecamatan tempat desa ini berada
          schema:
            type: string
            example: "357801"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, district_id]
              properties:
                name:
                  type: string
                  description: Nama desa/kelurahan
                  example: "Sukorejo"
                district_id:
                  type: string
                  description: ID kecamatan (harus sesuai dengan `districtId` di URL, opsional untuk divalidasi)
                  example: "357801"
      responses:
        '200':
          description: Desa berhasil ditambahkan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Village added successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/rajaongkir/estimate:
    post:
      tags: [Pengiriman]
      summary: Hitung estimasi ongkos kirim
      description: |
        Menghitung biaya pengiriman menggunakan layanan API pihak ketiga (api.co.id).
        Endpoint ini **tidak memerlukan autentikasi** dan dapat diakses oleh semua pengguna (termasuk tamu).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [origin_village_code, destination_village_code, weight]
              properties:
                origin_village_code:
                  type: string
                  description: Kode desa asal (sesuai data dari api.co.id)
                  example: "3578011001"
                destination_village_code:
                  type: string
                  description: Kode desa tujuan (sesuai data dari api.co.id)
                  example: "1274011002"
                weight:
                  type: integer
                  description: Berat paket dalam gram
                  example: 1500
               
      responses:
        '200':
          description: Respons sukses dari layanan ongkir
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  costs:
                    type: array
                    items:
                      type: object
                      properties:
                        service:
                          type: string
                          example: "JNE Regular"
                        description:
                          type: string
                          example: "(REG) 2-3 hari"
                        value:
                          type: integer
                          description: Harga dalam Rupiah
                          example: 22000
                        etd:
                          type: string
                          example: "2-3 hari"
        '400':
          description: Field wajib tidak lengkap atau format tidak valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Missing required fields: origin_village_code, destination_village_code, weight"
        '500':
          description: Gagal menghubungi layanan eksternal atau respons tidak valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Invalid response structure from API.co.id"

  /api/orders/user/{userId}:
    get:
      tags: [Pesanan]
      summary: Dapatkan semua pesanan milik pengguna
      description: |
        Mengambil daftar pesanan pengguna yang sedang login, termasuk detail alamat pengiriman dan item pesanan.
        - Hanya pengguna itu sendiri yang boleh mengakses.
        - Pesanan diurutkan dari yang terbaru.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ID pengguna (harus sesuai dengan ID di token JWT)
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Berhasil mengambil daftar pesanan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  orders:
                    type: array
                    items:
                      $ref: '#/components/schemas/PesananWithItemsResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Akses ditolak (userId tidak sesuai dengan token)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Forbidden"
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Pesanan]
      summary: Buat pesanan baru dari keranjang
      description: |
        Membuat pesanan baru berdasarkan item di keranjang pengguna.
        - Mengurangi stok produk.
        - Mengosongkan keranjang setelah pesanan dibuat.
        - Alamat pengiriman harus milik pengguna tersebut.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ID pengguna (harus sesuai dengan ID di token JWT)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [addressId, totalProductPrice, shippingCost, grandTotal]
              properties:
                addressId:
                  type: integer
                  description: ID alamat pengiriman (harus milik pengguna)
                  example: 456
                totalProductPrice:
                  type: integer
                  description: Total harga produk (tanpa ongkir)
                  example: 75000
                shippingCost:
                  type: integer
                  description: Biaya pengiriman
                  example: 12000
                grandTotal:
                  type: integer
                  description: Total keseluruhan (produk + ongkir)
                  example: 87000
                paymentMethod:
                  type: string
                  description: Metode pembayaran (opsional, default 'cod')
                  example: "cod"
      responses:
        '200':
          description: Pesanan berhasil dibuat
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  PesananId:
                    type: integer
                    example: 789
                  message:
                    type: string
                    example: "Pesanan created successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Alamat tidak ditemukan atau bukan milik pengguna
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Address not found or does not belong to user"
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Pesanan]
      summary: Perbarui seluruh status pesanan (contoh ke 'shipped')
      description: |
        Memperbarui status pesanan. Saat ini hanya mendukung perubahan status.
        - Hanya pemilik pesanan yang boleh mengubah.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ID pengguna (harus sesuai dengan ID di token JWT)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [PesananId, status]
              properties:
                PesananId:
                  type: integer
                  example: 789
                status:
                  type: string
                  description: Status baru pesanan
                  example: "shipped"
      responses:
        '200':
          description: Status pesanan berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Pesanan updated successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pesanan tidak ditemukan atau bukan milik pengguna
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Pesanan not found or does not belong to user"
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [Pesanan]
      summary: Perbarui sebagian status pesanan
      description: |
        Fungsionalitas serupa dengan PUT, tapi digunakan untuk perubahan parsial.
        (Dalam implementasimu saat ini, logikanya identik dengan PUT.)
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ID pengguna (harus sesuai dengan ID di token JWT)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [PesananId, status]
              properties:
                PesananId:
                  type: integer
                  example: 789
                status:
                  type: string
                  example: "delivered"
      responses:
        '200':
          description: Status pesanan berhasil diperbarui
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Pesanan partially updated successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pesanan tidak ditemukan atau bukan milik pengguna
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Pesanan not found or does not belong to user"
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Pesanan]
      summary: Batalkan pesanan (soft delete)
      description: |
        Membatalkan pesanan dengan mengubah statusnya menjadi 'cancelled'.
        Tidak menghapus data dari database.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: ID pengguna (harus sesuai dengan ID di token JWT)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [PesananId]
              properties:
                PesananId:
                  type: integer
                  example: 789
      responses:
        '200':
          description: Pesanan berhasil dibatalkan
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Pesanan cancelled successfully"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Pesanan tidak ditemukan atau bukan milik pengguna
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: "Pesanan not found or does not belong to user"
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ProductBase:
      type: object
      properties:
        id:
          type: integer
          example: 14
          description: ID unik produk
        name:
          type: string
          example: "a Merah"
          description: Nama produk
        description:
          type: string
          example: "Tomat segar dari Kedamean"
          description: Deskripsi produk
        price:
          type: integer
          example: 15000
          description: Harga per unit (dalam Rupiah)
        unit:
          type: string
          example: "kg"
          description: Satuan penjualan (misal kg, buah, ikat)
        stock:
          type: integer
          example: 50
          description: Stok tersedia (untuk status 'ready_stock') atau kuota (untuk 'pre_order')
        min_order:
          type: integer
          example: 5
          description: Jumlah minimal pemesanan
        seller_id:
          type: integer
          example: 1
          description: ID penjual yang menawarkan produk ini
        harvest_date:
          type: string
          format: date
          example: "2026-01-08"
          description: Tanggal panen produk
        image_path:
          type: string
          example: "/images/tomat.jpg"
          description: Jalur relatif ke gambar produk
        category:
          type: string
          example: "sayuran"
          description: Kategori produk
        status:
          type: string
          example: "pre-order"
          description: Status ketersediaan produk
          enum: [ "ready_stock", "pre_order", "sold_out", "deleted" ]
        created_at:
          type: string
          format: date-time
          example: "2026-01-08T02:56:52.153Z"
          description: Waktu pembuatan produk di sistem
        updated_at:
          type: string
          format: date-time
          example: "2026-01-08T02:56:52.153Z"
          description: Waktu terakhir produk diperbarui


    ProductCreateRequest:
      allOf:
        - $ref: '#/components/schemas/ProductBase'

    ProductResponse:
      allOf:
        - $ref: '#/components/schemas/ProductBase'
        - type: object
          required: [id, user_name, created_at, updated_at, status]
          properties:
            id:
              type: string
              format: numberic
              example: "2"
            user_name:
              type: string
              description: Nama seller (diambil dari tabel users)
              example: "Pak Tani"
            created_at:
              type: string
              format: date-time
              example: "2026-01-08T10:30:00Z"
            updated_at:
              type: string
              format: date-time
              example: "2026-01-08T10:30:00Z"
            status:
              type: string
              enum: [pre-order, inpre-order, sold_out, deleted]
              example: "ready_stock"

    AddressBase:
      type: object
      properties:
        detail:
          type: string
          example: "Jl. Raya Kedamean No. 10"
        cityId:
          type: string
          description: ID kota dari RajaOngkir atau api.co.id
          example: "3578"
        districtId:
          type: string
          description: ID kecamatan
          example: "357801"
        villageCode:
          type: string
          description: Kode desa (dari sumber API eksternal)
          example: "3578011001"
        province:
          type: string
          example: "Jawa Timur"
        zipCode:
          type: string
          example: "61151"

    AddressCreateRequest:
      allOf:
        - $ref: '#/components/schemas/AddressBase'

    AddressUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/AddressBase'
        - type: object
          properties:
            id:
              type: integer
              example: 123

    AddressResponse:
      allOf:
        - $ref: '#/components/schemas/AddressUpdateRequest'
        - type: object
          properties:
            createdAt:
              type: string
              format: date-time
              example: "2026-01-08T10:30:00Z"
            updatedAt:
              type: string
              format: date-time
              example: "2026-01-08T10:30:00Z"

    ProductRestockAction:
      type: object
      required: [action, quantity]
      properties:
        action:
          type: string
          enum: [restock]
          example: "restock"
        quantity:
          type: integer
          minimum: 1
          example: 100

    ProductUpdateMinPesananAction:
      type: object
      required: [action, min_Pesanan]
      properties:
        action:
          type: string
          enum: [update_min_Pesanan]
          example: "update_min_Pesanan"
        min_Pesanan:
          type: integer
          minimum: 1
          example: 5

    ProductCustomAction:
      type: object
      required: [action]
      properties:
        action:
          type: string
          example: "custom_action"

    ProductUpdateRequest:
      allOf:
        - $ref: '#/components/schemas/ProductBase'

    ProductPartialUpdateRequest:
      type: object
      properties:
        name:
          type: string
          example: "Tomat Merah"
        description:
          type: string
          nullable: true
          example: "Tomat segar dari Kedamean"
        price:
          type: number
          minimum: 0
          example: 15000
        unit:
          type: string
          example: "kg"
        stock:
          type: integer
          minimum: 0
          example: 50
        min_Pesanan:
          type: integer
          minimum: 1
          example: 1
        harvest_date:
          type: string
          format: date
          nullable: true
          example: "2026-01-08"
        image_path:
          type: string
          nullable: true
          example: "/images/tomat.jpg"
        category:
          type: string
          nullable: true
          example: "sayuran"
        status:
          type: string
          enum: [pre-order, inpre-order, sold_out]
          example: "ready_stock"

    ForbiddenError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: "Forbidden"

    PesananWithItemsResponse:
      type: object
      properties:
        id:
          type: integer
          example: 789
        userId:
          type: string
          example: "123"
        addressId:
          type: integer
          example: 456
        status:
          type: string
          example: "pending"
        totalProductPrice:
          type: integer
          example: 75000
        shippingCost:
          type: integer
          example: 12000
        grandTotal:
          type: integer
          example: 87000
        createdAt:
          type: string
          format: date-time
          example: "2026-01-08T15:30:00Z"
        updatedAt:
          type: string
          format: date-time
          example: "2026-01-08T15:30:00Z"
        address:
          $ref: '#/components/schemas/AddressBase'
        PesananItems:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                example: 101
              PesananId:
                type: integer
                example: 789
              productId:
                type: integer
                example: 201
              productName:
                type: string
                example: "Apel Malang"
              productImage:
                type: string
                example: "/images/apel.jpg"
              priceAtPesanan:
                type: integer
                example: 15000
              quantity:
                type: integer
                example: 5

    APIError:
      type: object
      description: Struktur standar untuk semua respons error API
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Pesan kesalahan dalam bahasa Indonesia
          example: "Email dan password wajib diisi"
      required: [success, error]

  responses:
    UnauthorizedError:
      description: Token autentikasi tidak ditemukan atau tidak valid
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "Unauthorized"

    BadRequestError:
      description: Payload permintaan tidak valid (misalnya field wajib tidak dikirim atau format salah)
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "Invalid cart item ID"

    NotFoundError:
      description: Alamat tidak ditemukan atau bukan milik pengguna
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "Forbidden"

    InternalServerError:
      description: Terjadi kesalahan tak terduga pada server
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "internal server error"
    
    ForbiddenError:
      description: Akses ditolak — pengguna tidak memiliki izin untuk mengakses sumber daya ini
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              error:
                type: string
                example: "Akses ditolak"

      